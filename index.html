<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de RPG Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #1a1a2e; --panel-bg: #16213e; --accent: #6efaf2; --danger: #ff7676; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: #e6e6e6;
            min-height: 100vh;
            padding: 20px;
        }

        .main-wrapper {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- DADOS (DIREITA) --- */
        .dice-3d-section {
            background-color: #0f3460;
            border-radius: 15px;
            padding: 15px;
            height: fit-content;
            position: sticky;
            top: 20px;
            border: 2px solid #3a506b;
        }

        .dice-3d-container {
            width: 100%;
            height: 350px;
            background: #202124;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .dice-label {
            position: absolute; font-weight: bold; color: white; pointer-events: none;
            text-shadow: 0px 0px 4px rgba(0,0,0,0.8); font-size: 24px; z-index: 10;
            transform: translate(-50%, -50%);
        }

        .total-display-3d {
            position: absolute; bottom: 10px; right: 15px; text-align: right; pointer-events: none;
        }
        .total-value-3d { font-size: 45px; font-weight: bold; color: var(--accent); }

        .dice-bar-3d { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .dice-btn-3d {
            padding: 10px; border: none; cursor: pointer; color: white; font-weight: bold;
            border-radius: 6px; transition: transform 0.1s;
        }
        .b-d4 { background: #34a853; } .b-d6 { background: #24b6d2; }
        .b-d8 { background: #a142f4; } .b-d10 { background: #d93025; }
        .b-d12 { background: #ea4335; } .b-d20 { background: #f29900; }

        /* --- FICHAS (ESQUERDA) --- */
        .character-card {
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #3a506b;
        }

        .char-header { display: flex; gap: 20px; margin-bottom: 15px; }
        .char-image-container {
            width: 120px; height: 120px; border-radius: 10px; 
            overflow: hidden; border: 3px solid var(--accent);
            cursor: pointer;
        }
        .char-image-container img { width: 100%; height: 100%; object-fit: cover; }

        /* Barra de Vida */
        .hp-container { margin: 15px 0; }
        .hp-bar-bg { height: 20px; background: #0a0a1a; border-radius: 10px; overflow: hidden; border: 1px solid #3a506b; }
        .hp-bar-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.3s ease; }
        
        /* Calculadora de Vida */
        .hp-calc-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
        .hp-input { width: 70px; padding: 5px; background: #0f3460; border: 1px solid var(--accent); color: white; border-radius: 4px; text-align: center; }
        .calc-display { flex: 1; background: #0a0a1a; padding: 5px 10px; border-radius: 4px; font-family: monospace; color: var(--accent); cursor: pointer; }

        .attribute-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px; margin: 15px 0;
        }
        .attr-box { background: #0f3460; padding: 10px; border-radius: 8px; text-align: center; }
        .attr-box input { width: 100%; background: transparent; border: none; color: var(--accent); text-align: center; font-size: 18px; font-weight: bold; }

        .btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-add { background: var(--accent); color: #1a1a2e; margin-bottom: 20px; }
        .btn-add:hover { filter: brightness(1.2); }

        @media (max-width: 1000px) {
            .main-wrapper { grid-template-columns: 1fr; }
            .dice-3d-section { position: relative; top: 0; }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div>
        <button class="btn btn-add" onclick="addNewCharacter()">+ Novo Personagem</button>
        <div id="charactersList"></div>
    </div>

    <div class="dice-3d-section">
        <h3 style="text-align: center; margin-bottom: 10px;">Mesa de Dados</h3>
        <div class="dice-3d-container" id="viewport">
            <div class="total-display-3d">
                <div style="font-size: 12px; opacity: 0.7;">SOMA</div>
                <span class="total-value-3d" id="res-total">0</span>
            </div>
        </div>
        
        <div style="text-align: center; margin: 10px 0; font-size: 14px;">
            Quantidade: <span id="qty-val" style="color: var(--accent);">1</span>
        </div>

        <div class="dice-bar-3d">
            <button class="dice-btn-3d b-d4" onclick="spawnDice('d4')">D4</button>
            <button class="dice-btn-3d b-d6" onclick="spawnDice('d6')">D6</button>
            <button class="dice-btn-3d b-d8" onclick="spawnDice('d8')">D8</button>
            <button class="dice-btn-3d b-d10" onclick="spawnDice('d10')">D10</button>
            <button class="dice-btn-3d b-d12" onclick="spawnDice('d12')">D12</button>
            <button class="dice-btn-3d b-d20" onclick="spawnDice('d20')">D20</button>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:#3a506b; color:white;" onclick="rollAll()">ROLAR TUDO</button>
        <button class="btn" style="width:100%; margin-top:5px; background:#5f6368; color:white;" onclick="toggleMod()">ALTERAR QUANTIDADE</button>
    </div>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';

    // --- LÓGICA DOS DADOS 3D ---
    let scene, camera, renderer, raycaster, mouse;
    let diceList = [];
    let quantity = 1;
    const container = document.getElementById('viewport');
    const GRID_COLS = 3;
    const GRID_SPACING = 2.6;

    const configs = {
        'd4':  { geo: new THREE.TetrahedronGeometry(1.2), color: 0x34a853, sides: 4, rot: {x: 0.55, y: 0.8} },
        'd6':  { geo: new THREE.BoxGeometry(1.3, 1.3, 1.3), color: 0x24b6d2, sides: 6, rot: {x: 0, y: 0} },
        'd8':  { geo: new THREE.OctahedronGeometry(1.3), color: 0xa142f4, sides: 8, rot: {x: 0.35, y: 0.8} },
        'd10': { geo: new THREE.IcosahedronGeometry(1.3, 0), color: 0xd93025, sides: 10, rot: {x: 0, y: 0} },
        'd12': { geo: new THREE.DodecahedronGeometry(1.3), color: 0xea4335, sides: 12, rot: {x: 0, y: 0} },
        'd20': { geo: new THREE.IcosahedronGeometry(1.3, 0), color: 0xf29900, sides: 20, rot: {x: 0.4, y: 0} }
    };

    function init3D() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.z = 12;
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 1));
        const light = new THREE.DirectionalLight(0xffffff, 0.5);
        light.position.set(5, 5, 10);
        scene.add(light);
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        container.addEventListener('mousedown', (e) => {
            const rect = container.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / container.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(diceList);
            if(intersects.length > 0) removeDice(intersects[0].object);
        });
        animate();
    }

    window.spawnDice = (type) => {
        for(let i=0; i<quantity; i++) {
            if(diceList.length >= 12) break;
            const conf = configs[type];
            const mesh = new THREE.Mesh(conf.geo, new THREE.MeshPhongMaterial({ color: conf.color, flatShading: true, transparent: true, opacity: 1 }));
            const label = document.createElement('div');
            label.className = 'dice-label';
            container.appendChild(label);
            mesh.userData = { type, sides: conf.sides, label, value: 0, isRemoving: false };
            scene.add(mesh);
            diceList.push(mesh);
        }
        rollAll();
    };

    window.rollAll = () => {
        diceList.forEach(dice => {
            if(dice.userData.isRemoving) return;
            const result = Math.floor(Math.random() * dice.userData.sides) + 1;
            dice.userData.value = result;
            dice.userData.label.style.display = 'none';
            let start = Date.now();
            const dur = 600;
            const roll = () => {
                const elapsed = Date.now() - start;
                if(elapsed < dur) {
                    dice.rotation.x += 0.4; dice.rotation.y += 0.4;
                    requestAnimationFrame(roll);
                } else {
                    dice.userData.label.innerText = result;
                    dice.userData.label.style.display = 'block';
                    const targetRot = configs[dice.userData.type].rot;
                    dice.rotation.set(targetRot.x, targetRot.y, 0);
                    updateTotal();
                }
            };
            roll();
        });
    };

    function removeDice(obj) {
        obj.userData.isRemoving = true;
        obj.userData.label.style.display = 'none';
        let start = Date.now();
        const anim = () => {
            const p = (Date.now() - start) / 300;
            if(p < 1) {
                obj.scale.set(1-p, 1-p, 1-p);
                obj.position.z -= 0.2;
                requestAnimationFrame(anim);
            } else {
                container.removeChild(obj.userData.label);
                scene.remove(obj);
                diceList = diceList.filter(d => d !== obj);
                updateTotal();
            }
        };
        anim();
    }

    function updateTotal() {
        const total = diceList.reduce((acc, d) => acc + (d.userData.isRemoving ? 0 : d.userData.value), 0);
        document.getElementById('res-total').innerText = total;
    }

    function animate() {
        requestAnimationFrame(animate);
        diceList.forEach((dice, i) => {
            const col = i % GRID_COLS;
            const row = Math.floor(i / GRID_COLS);
            const tx = (col - (GRID_COLS-1)/2) * GRID_SPACING;
            const ty = (1.2 - row) * GRID_SPACING;
            if(!dice.userData.isRemoving) {
                dice.position.x += (tx - dice.position.x) * 0.1;
                dice.position.y += (ty - dice.position.y) * 0.1;
            }
            const vector = dice.position.clone().project(camera);
            dice.userData.label.style.left = `${(vector.x + 1) * container.clientWidth / 2}px`;
            dice.userData.label.style.top = `${(-vector.y + 1) * container.clientHeight / 2}px`;
        });
        renderer.render(scene, camera);
    }

    window.toggleMod = () => {
        quantity = quantity >= 5 ? 1 : quantity + 1;
        document.getElementById('qty-val').innerText = quantity;
    };

    // --- LÓGICA DE PERSONAGENS & CALCULADORA ---
    window.addNewCharacter = () => {
        const id = Date.now();
        const charHtml = `
            <div class="character-card" id="char-${id}">
                <div class="char-header">
                    <div class="char-image-container" onclick="document.getElementById('img-${id}').click()">
                        <img src="https://via.placeholder.com/120" id="view-${id}">
                        <input type="file" id="img-${id}" hidden onchange="updateImg(this, '${id}')">
                    </div>
                    <div style="flex:1">
                        <input type="text" placeholder="Nome do Personagem" style="width:100%; padding:8px; background:#0f3460; border:none; color:white; font-size:20px; border-radius:5px;">
                        
                        <div class="hp-container">
                            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px">
                                <span>VIDA</span>
                                <span id="hp-text-${id}">100 / 100</span>
                            </div>
                            <div class="hp-bar-bg">
                                <div class="hp-bar-fill" id="hp-fill-${id}" style="width: 100%"></div>
                            </div>
                            
                            <div class="hp-calc-row">
                                <input type="number" id="hp-max-${id}" class="hp-input" value="100" onchange="updateHP('${id}')" title="Vida Máxima">
                                <div class="calc-display" id="display-${id}" title="Ex: -10 ou +15. Aperte ENTER">Calcular: 0</div>
                                <input type="text" class="hp-input" id="calc-input-${id}" placeholder="+/-" onkeypress="handleHPCalc(event, '${id}')">
                            </div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('char-${id}').remove()" style="color:red; background:none; border:none; cursor:pointer"><i class="fas fa-times"></i></button>
                </div>
                <div class="attribute-grid">
                    <div class="attr-box"><div>FOR</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>DES</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>CON</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>INT</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>SAB</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>CAR</div><input type="number" value="10"></div>
                </div>
            </div>
        `;
        document.getElementById('charactersList').insertAdjacentHTML('afterbegin', charHtml);
        
        // Estado inicial da vida
        window[`char_hp_${id}`] = 100;
    };

    window.updateHP = (id) => {
        const max = parseInt(document.getElementById(`hp-max-${id}`).value) || 1;
        let current = window[`char_hp_${id}`];
        if (current > max) current = max;
        window[`char_hp_${id}`] = current;
        
        const perc = (current / max) * 100;
        document.getElementById(`hp-fill-${id}`).style.width = perc + "%";
        document.getElementById(`hp-text-${id}`).innerText = `${current} / ${max}`;
        
        // Muda cor se estiver morrendo
        document.getElementById(`hp-fill-${id}`).style.background = perc < 25 ? "#ff4757" : "linear-gradient(90deg, #2ecc71, #27ae60)";
    };

    window.handleHPCalc = (event, id) => {
        if (event.key === 'Enter') {
            const input = document.getElementById(`calc-input-${id}`);
            const val = input.value;
            try {
                // O eval permite que o usuário digite "-10", "+5", "2*5" etc.
                const change = eval(val);
                if (typeof change === 'number') {
                    const max = parseInt(document.getElementById(`hp-max-${id}`).value);
                    let newHP = window[`char_hp_${id}`] + change;
                    
                    // Limites
                    if (newHP > max) newHP = max;
                    if (newHP < 0) newHP = 0;
                    
                    window[`char_hp_${id}`] = newHP;
                    document.getElementById(`display-${id}`).innerText = "Resultado: " + change;
                    updateHP(id);
                    input.value = "";
                }
            } catch (e) {
                document.getElementById(`display-${id}`).innerText = "Erro!";
            }
        }
    };

    window.updateImg = (input, id) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById(`view-${id}`).src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    };

    init3D();
</script>
</body>
</html>