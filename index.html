<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Manager - Advanced Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #1a1a2e; --panel-bg: #16213e; --accent: #6efaf2; --danger: #ff4757; --dead: #555; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg-dark); color: #e6e6e6; min-height: 100vh; padding: 20px; }

        .main-wrapper {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- DADOS (DIREITA) --- */
        .dice-3d-section {
            background-color: #0f3460; border-radius: 15px; padding: 15px;
            height: fit-content; position: sticky; top: 20px; border: 2px solid #3a506b;
        }
        .dice-3d-container {
            width: 100%; height: 350px; background: #202124; border-radius: 8px;
            position: relative; overflow: hidden;
        }
        .dice-label {
            position: absolute; font-weight: bold; color: white; pointer-events: none;
            text-shadow: 0px 0px 4px rgba(0,0,0,0.8); font-size: 24px; z-index: 10;
            transform: translate(-50%, -50%);
        }
        .total-display-3d { position: absolute; bottom: 10px; right: 15px; text-align: right; pointer-events: none; }
        .total-value-3d { font-size: 45px; font-weight: bold; color: var(--accent); }
        .dice-bar-3d { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .dice-btn-3d { padding: 10px; border: none; cursor: pointer; color: white; font-weight: bold; border-radius: 6px; }

        /* --- FICHAS (ESQUERDA) --- */
        .character-card {
            background: var(--panel-bg); border-radius: 15px; padding: 25px;
            margin-bottom: 25px; border: 1px solid #3a506b; transition: 0.5s;
        }
        
        /* Efeito de Morte */
        .character-card.is-dead { border-color: var(--danger); box-shadow: 0 0 20px rgba(255, 71, 87, 0.4); }
        .character-card.is-dead .char-image-container { filter: grayscale(1) brightness(0.6); border-color: var(--danger); }
        .character-card.is-dead .hp-bar-fill { background: var(--dead) !important; }

        .char-left-col { display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; }
        .death-icon { position: absolute; top: 40px; font-size: 50px; color: white; opacity: 0; transition: 0.5s; pointer-events: none; z-index: 5; }
        .is-dead .death-icon { opacity: 0.8; }

        .char-header { display: flex; gap: 20px; margin-bottom: 20px; }
        .char-image-container {
            width: 140px; height: 140px; border-radius: 12px; 
            overflow: hidden; border: 3px solid var(--accent); cursor: pointer; transition: 0.5s;
        }
        .char-image-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .header-inputs { flex: 1; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; }
        .full-row { grid-column: span 3; }
        
        .rpg-input { background: #0f3460; border: 1px solid #3a506b; color: white; padding: 8px; border-radius: 5px; width: 100%; }
        .rpg-label { font-size: 11px; color: var(--accent); font-weight: bold; display: block; margin-bottom: 2px; }
        .player-name-input { background: transparent; border: none; border-bottom: 1px solid #3a506b; color: #ccc; text-align: center; font-size: 13px; width: 140px; padding: 4px; }

        .hp-section { margin: 15px 0; }
        .hp-bar-bg { height: 24px; background: #0a0a1a; border-radius: 12px; overflow: hidden; border: 1px solid #3a506b; position: relative; }
        .hp-bar-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.4s ease; }
        .hp-text-overlay { position: absolute; width: 100%; text-align: center; font-weight: bold; font-size: 14px; top: 2px; text-shadow: 1px 1px 2px black; }
        
        .attribute-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 20px 0; }
        .attr-box { background: #0f3460; padding: 10px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--accent); }
        .attr-box input { width: 100%; background: transparent; border: none; color: white; text-align: center; font-size: 20px; font-weight: bold; }

        .btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
        .btn-add { background: var(--accent); color: #1a1a2e; margin-bottom: 20px; }
        .b-d4 { background: #34a853; } .b-d6 { background: #24b6d2; }
        .b-d8 { background: #a142f4; } .b-d10 { background: #d93025; }
        .b-d12 { background: #ea4335; } .b-d20 { background: #f29900; }
        .b-custom { background: #f1c40f; color: #000 !important; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div>
        <button class="btn btn-add" onclick="addNewCharacter()">+ Novo Personagem</button>
        <div id="charactersList"></div>
    </div>

    <div class="dice-3d-section">
        <h3 style="text-align: center; margin-bottom: 10px;">Mesa de Dados</h3>
        <div class="dice-3d-container" id="viewport">
            <div class="total-display-3d"><span class="total-value-3d" id="res-total">0</span></div>
        </div>
        <div class="dice-bar-3d">
            <button class="dice-btn-3d b-d4" onclick="spawnDice('d4')">D4</button>
            <button class="dice-btn-3d b-d6" onclick="spawnDice('d6')">D6</button>
            <button class="dice-btn-3d b-d8" onclick="spawnDice('d8')">D8</button>
            <button class="dice-btn-3d b-d10" onclick="spawnDice('d10')">D10</button>
            <button class="dice-btn-3d b-d12" onclick="spawnDice('d12')">D12</button>
            <button class="dice-btn-3d b-d20" onclick="spawnDice('d20')">D20</button>
            <button class="dice-btn-3d b-custom" style="grid-column: span 3" onclick="spawnCustomDice()">DADO PERSONALIZADO (D?)</button>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:#3a506b; color:white;" onclick="rollAll()">ROLAR TODOS</button>
    </div>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';

    let scene, camera, renderer, raycaster, mouse, diceList = [];
    const container = document.getElementById('viewport');
    
    const configs = {
        'd4': {geo: new THREE.TetrahedronGeometry(1.2), color: 0x34a853, sides: 4, rot: {x: 0.55, y: 0.8}},
        'd6': {geo: new THREE.BoxGeometry(1.3, 1.3, 1.3), color: 0x24b6d2, sides: 6, rot: {x: 0, y: 0}},
        'd8': {geo: new THREE.OctahedronGeometry(1.3), color: 0xa142f4, sides: 8, rot: {x: 0.35, y: 0.8}},
        'd10': {geo: new THREE.IcosahedronGeometry(1.3, 0), color: 0xd93025, sides: 10, rot: {x: 0, y: 0}},
        'd12': {geo: new THREE.DodecahedronGeometry(1.3), color: 0xea4335, sides: 12, rot: {x: 0, y: 0}},
        'd20': {geo: new THREE.IcosahedronGeometry(1.3, 0), color: 0xf29900, sides: 20, rot: {x: 0.4, y: 0}},
        'custom': {geo: new THREE.SphereGeometry(1.1, 8, 8), color: 0xf1c40f, sides: 100, rot: {x: 0, y: 0}}
    };

    function init3D() {
        scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.z = 12; renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight); container.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 1)); 
        const light = new THREE.DirectionalLight(0xffffff, 0.5); light.position.set(5, 5, 10); scene.add(light);
        raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();
        container.addEventListener('mousedown', (e) => {
            const rect = container.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / container.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(diceList);
            if(hits.length > 0) removeDice(hits[0].object);
        });
        animate();
    }

    window.rollSingleDice = (dice) => {
        if(dice.userData.isRemoving) return;
        const res = Math.floor(Math.random() * dice.userData.sides) + 1;
        dice.userData.value = res; dice.userData.label.style.display = 'none';
        let start = Date.now();
        const rollAnim = () => {
            if(Date.now() - start < 600) { dice.rotation.x += 0.4; dice.rotation.y += 0.4; requestAnimationFrame(rollAnim); }
            else { 
                dice.userData.label.innerText = res; dice.userData.label.style.display = 'block';
                const c = configs[dice.userData.type] || configs['custom'];
                dice.rotation.set(c.rot.x, c.rot.y, 0);
                updateTotal();
            }
        };
        rollAnim();
    }

    window.spawnDice = (type, customSides = null) => {
        if(diceList.length >= 12) return;
        const conf = configs[type];
        const mesh = new THREE.Mesh(conf.geo, new THREE.MeshPhongMaterial({ color: conf.color, flatShading: true, transparent: true }));
        const label = document.createElement('div'); label.className = 'dice-label'; container.appendChild(label);
        mesh.userData = { type, sides: customSides || conf.sides, label, value: 0, isRemoving: false };
        scene.add(mesh); diceList.push(mesh);
        rollSingleDice(mesh);
    }

    window.spawnCustomDice = () => {
        const s = prompt("Quantas faces tem o dado?", "100");
        if(s && !isNaN(s)) spawnDice('custom', parseInt(s));
    }

    window.rollAll = () => { diceList.forEach(d => rollSingleDice(d)); }

    function removeDice(obj) {
        obj.userData.isRemoving = true; obj.userData.label.style.display = 'none';
        let start = Date.now();
        const anim = () => {
            const p = (Date.now() - start) / 300;
            if(p < 1) { obj.scale.set(1-p, 1-p, 1-p); requestAnimationFrame(anim); }
            else { if(obj.userData.label.parentNode) container.removeChild(obj.userData.label); scene.remove(obj); diceList = diceList.filter(d => d !== obj); updateTotal(); }
        };
        anim();
    }

    function updateTotal() {
        const total = diceList.reduce((acc, d) => acc + (d.userData.isRemoving ? 0 : d.userData.value), 0);
        document.getElementById('res-total').innerText = total;
    }

    function animate() {
        requestAnimationFrame(animate);
        diceList.forEach((dice, i) => {
            const tx = (i % 3 - 1) * 2.6; const ty = (1.2 - Math.floor(i / 3)) * 2.6;
            if(!dice.userData.isRemoving) { dice.position.x += (tx - dice.position.x) * 0.1; dice.position.y += (ty - dice.position.y) * 0.1; }
            const vector = dice.position.clone().project(camera);
            dice.userData.label.style.left = `${(vector.x + 1) * container.clientWidth / 2}px`;
            dice.userData.label.style.top = `${(-vector.y + 1) * container.clientHeight / 2}px`;
        });
        renderer.render(scene, camera);
    }

    // --- PERSONAGENS ---
    window.addNewCharacter = () => {
        const id = Date.now();
        const html = `
            <div class="character-card" id="char-${id}">
                <div class="char-header">
                    <div class="char-left-col">
                        <i class="fas fa-skull death-icon"></i>
                        <div class="char-image-container" onclick="document.getElementById('img-${id}').click()">
                            <img src="https://via.placeholder.com/140" id="view-${id}">
                            <input type="file" id="img-${id}" hidden onchange="updateImg(this, '${id}')">
                        </div>
                        <input type="text" class="player-name-input" placeholder="Nome do Jogador">
                    </div>
                    <div class="header-inputs">
                        <div class="full-row"><span class="rpg-label">NOME DO PERSONAGEM</span><input type="text" class="rpg-input"></div>
                        <div><span class="rpg-label">CLASSE</span><input type="text" class="rpg-input"></div>
                        <div><span class="rpg-label">RAÇA</span><input type="text" class="rpg-input"></div>
                        <div><span class="rpg-label">NÍVEL</span><input type="number" class="rpg-input" value="1"></div>
                    </div>
                    <button onclick="document.getElementById('char-${id}').remove()" style="color:var(--danger); background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                </div>
                <div class="hp-section">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px">
                        <span>PONTOS DE VIDA</span><span id="hp-text-${id}">100 / 100</span>
                    </div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="hp-fill-${id}" style="width: 100%"></div><div class="hp-text-overlay" id="hp-perc-${id}">100%</div></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <div style="flex:1">
                            <span class="rpg-label">VIDA MÁXIMA</span>
                            <input type="number" id="hp-max-${id}" class="rpg-input" value="100" onchange="setMaxHP('${id}')">
                        </div>
                        <div style="flex:2">
                            <span class="rpg-label">DANO / CURA (ENTER)</span>
                            <input type="text" class="rpg-input" id="calc-input-${id}" onkeypress="handleHPCalc(event, '${id}')" placeholder="Ex: -10">
                        </div>
                    </div>
                </div>
                <div class="attribute-grid">
                    <div class="attr-box"><div>FOR</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>DES</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>CON</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>INT</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>SAB</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>CAR</div><input type="number" value="10"></div>
                </div>
            </div>
        `;
        document.getElementById('charactersList').insertAdjacentHTML('afterbegin', html);
        window[`char_hp_${id}`] = 100;
    };

    window.setMaxHP = (id) => {
        const newMax = parseInt(document.getElementById(`hp-max-${id}`).value) || 1;
        window[`char_hp_${id}`] = newMax; // Quando muda o max, a vida vem full
        updateHPDisplay(id);
    };

    window.updateHPDisplay = (id) => {
        const max = parseInt(document.getElementById(`hp-max-${id}`).value) || 1;
        const current = window[`char_hp_${id}`];
        const perc = Math.round((current / max) * 100);
        const card = document.getElementById(`char-${id}`);
        
        document.getElementById(`hp-fill-${id}`).style.width = perc + "%";
        document.getElementById(`hp-text-${id}`).innerText = `${current} / ${max}`;
        document.getElementById(`hp-perc-${id}`).innerText = perc + "%";
        
        // Cor da barra
        document.getElementById(`hp-fill-${id}`).style.background = perc < 30 ? "var(--danger)" : "linear-gradient(90deg, #2ecc71, #27ae60)";

        // Sistema de Morte
        if(current <= 0) card.classList.add('is-dead');
        else card.classList.remove('is-dead');
    };

    window.handleHPCalc = (event, id) => {
        if (event.key === 'Enter') {
            try {
                const change = eval(event.target.value);
                if (typeof change === 'number') {
                    const max = parseInt(document.getElementById(`hp-max-${id}`).value);
                    window[`char_hp_${id}`] = Math.max(0, Math.min(max, window[`char_hp_${id}`] + change));
                    updateHPDisplay(id);
                    event.target.value = "";
                }
            } catch (e) { alert("Cálculo inválido!"); }
        }
    };

    window.updateImg = (input, id) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById(`view-${id}`).src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    };

    init3D();
</script>
</body>
</html>