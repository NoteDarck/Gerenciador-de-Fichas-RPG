<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Manager - Interactive Dice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #1a1a2e; --panel-bg: #16213e; --accent: #6efaf2; --danger: #ff4757; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg-dark); color: #e6e6e6; min-height: 100vh; padding: 20px; }

        .main-wrapper {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- MESA DE DADOS --- */
        .dice-3d-section {
            background-color: #0f3460; border-radius: 15px; padding: 15px;
            height: fit-content; position: sticky; top: 20px; border: 2px solid #3a506b;
        }
        .dice-3d-container {
            width: 100%; height: 350px; background: #202124; border-radius: 8px;
            position: relative; overflow: hidden; border: 1px solid #3a506b; cursor: crosshair;
        }
        .dice-label {
            position: absolute; font-weight: bold; color: white; pointer-events: none;
            text-shadow: 0px 0px 6px rgba(0,0,0,1); font-size: 26px; z-index: 100;
            transform: translate(-50%, -50%);
        }
        .total-display-3d { position: absolute; bottom: 10px; right: 15px; text-align: right; pointer-events: none; }
        .total-value-3d { font-size: 45px; font-weight: bold; color: var(--accent); }
        .dice-bar-3d { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .dice-btn-3d { padding: 10px; border: none; cursor: pointer; color: white; font-weight: bold; border-radius: 6px; }

        /* --- FICHAS --- */
        .character-card {
            background: var(--panel-bg); border-radius: 15px; padding: 25px;
            margin-bottom: 25px; border: 1px solid #3a506b; transition: 0.8s ease; position: relative;
        }
        
        .character-card.is-dead { 
            border-color: var(--danger); opacity: 0.4; filter: grayscale(1);
            transform: scale(0.95); box-shadow: 0 0 30px rgba(255, 71, 87, 0.5);
        }

        .char-header { display: flex; gap: 20px; margin-bottom: 20px; }
        .char-image-container {
            width: 140px; height: 140px; border-radius: 12px; 
            overflow: hidden; border: 3px solid var(--accent); cursor: pointer;
        }
        .char-image-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .header-inputs { flex: 1; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; }
        .full-row { grid-column: span 3; }
        .rpg-input { background: #0f3460; border: 1px solid #3a506b; color: white; padding: 8px; border-radius: 5px; width: 100%; }
        .rpg-label { font-size: 11px; color: var(--accent); font-weight: bold; display: block; margin-bottom: 2px; }

        .hp-section { margin: 15px 0; }
        .hp-bar-bg { height: 24px; background: #0a0a1a; border-radius: 12px; overflow: hidden; border: 1px solid #3a506b; position: relative; }
        .hp-bar-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.4s ease; }
        .hp-text-overlay { position: absolute; width: 100%; text-align: center; font-weight: bold; font-size: 14px; top: 2px; text-shadow: 1px 1px 2px black; }
        
        .attribute-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 20px 0; }
        .attr-box { background: #0f3460; padding: 10px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--accent); }
        .attr-box input { width: 100%; background: transparent; border: none; color: white; text-align: center; font-size: 18px; font-weight: bold; }

        .btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
        .btn-add { background: var(--accent); color: #1a1a2e; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div>
        <button class="btn btn-add" onclick="addNewCharacter()">+ NOVO PERSONAGEM</button>
        <div id="charactersList"></div>
    </div>

    <div class="dice-3d-section">
        <h3 style="text-align: center; margin-bottom: 5px;">Mesa de Dados</h3>
        <p style="text-align: center; font-size: 10px; color: var(--accent); margin-bottom: 10px;">Clique no dado para removê-lo</p>
        <div class="dice-3d-container" id="viewport">
            <div class="total-display-3d"><span class="total-value-3d" id="res-total">0</span></div>
        </div>
        <div class="dice-bar-3d">
            <button class="dice-btn-3d" style="background:#34a853" onclick="askDiceCount('d4')">D4</button>
            <button class="dice-btn-3d" style="background:#24b6d2" onclick="askDiceCount('d6')">D6</button>
            <button class="dice-btn-3d" style="background:#a142f4" onclick="askDiceCount('d8')">D8</button>
            <button class="dice-btn-3d" style="background:#d93025" onclick="askDiceCount('d10')">D10</button>
            <button class="dice-btn-3d" style="background:#ea4335" onclick="askDiceCount('d12')">D12</button>
            <button class="dice-btn-3d" style="background:#f29900" onclick="askDiceCount('d20')">D20</button>
            <button class="dice-btn-3d" style="background:#f1c40f; color:#000; grid-column: span 3" onclick="askDiceCount('custom')">DADO PERSONALIZADO (D?)</button>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:#3a506b; color:white;" onclick="rollAll()">REROLAR TUDO</button>
    </div>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';

    let scene, camera, renderer, diceList = [], raycaster, mouse;
    const container = document.getElementById('viewport');
    
    const configs = {
        'd4': {geo: new THREE.TetrahedronGeometry(1.2), color: 0x34a853, sides: 4},
        'd6': {geo: new THREE.BoxGeometry(1.3, 1.3, 1.3), color: 0x24b6d2, sides: 6},
        'd8': {geo: new THREE.OctahedronGeometry(1.3), color: 0xa142f4, sides: 8},
        'd10': {geo: new THREE.IcosahedronGeometry(1.3, 0), color: 0xd93025, sides: 10},
        'd12': {geo: new THREE.DodecahedronGeometry(1.3), color: 0xea4335, sides: 12},
        'd20': {geo: new THREE.IcosahedronGeometry(1.3, 0), color: 0xf29900, sides: 20},
        'custom': {geo: new THREE.SphereGeometry(1.1, 8, 8), color: 0xf1c40f, sides: 100}
    };

    function init3D() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.z = 12;
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);
        
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const light = new THREE.DirectionalLight(0xffffff, 0.5);
        light.position.set(5, 5, 10);
        scene.add(light);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        container.addEventListener('mousedown', onDiceClick);
        animate();
    }

    function onDiceClick(event) {
        const rect = container.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / container.clientWidth) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / container.clientHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(diceList);

        if (intersects.length > 0) {
            removeDice(intersects[0].object);
        }
    }

    function removeDice(dice) {
        if(dice.userData.isRemoving) return;
        dice.userData.isRemoving = true;
        dice.userData.label.style.display = 'none';

        const startScale = dice.scale.x;
        const startZ = dice.position.z;
        let startTime = Date.now();

        const anim = () => {
            let elapsed = Date.now() - startTime;
            let progress = elapsed / 400; // 400ms animação

            if (progress < 1) {
                dice.scale.set(startScale * (1 - progress), startScale * (1 - progress), startScale * (1 - progress));
                dice.position.z = startZ - (progress * 5);
                requestAnimationFrame(anim);
            } else {
                scene.remove(dice);
                dice.userData.label.remove();
                diceList = diceList.filter(d => d !== dice);
                updateTotal();
            }
        };
        anim();
    }

    window.askDiceCount = (type) => {
        let sides = null;
        if(type === 'custom') {
            const s = prompt("Lados?");
            if(!s) return; sides = parseInt(s);
        }
        const count = prompt("Quantos?", "1");
        if(count) {
            for(let i=0; i<Math.min(parseInt(count), 12); i++) spawnDice(type, sides);
        }
    }

    function spawnDice(type, sides) {
        const conf = configs[type] || configs['custom'];
        const mesh = new THREE.Mesh(conf.geo, new THREE.MeshPhongMaterial({ color: conf.color, flatShading: true }));
        const label = document.createElement('div'); label.className = 'dice-label'; container.appendChild(label);
        mesh.userData = { sides: sides || conf.sides, label, value: 0 };
        scene.add(mesh); diceList.push(mesh);
        rollSingle(mesh);
    }

    function rollSingle(dice) {
        if(dice.userData.isRemoving) return;
        dice.userData.label.style.display = 'none';
        const res = Math.floor(Math.random() * dice.userData.sides) + 1;
        
        let start = Date.now();
        const anim = () => {
            if (Date.now() - start < 600) {
                dice.rotation.x += 0.3; dice.rotation.y += 0.3;
                requestAnimationFrame(anim);
            } else {
                dice.userData.value = res;
                dice.userData.label.innerText = res;
                dice.userData.label.style.display = 'block';
                dice.rotation.set(0,0,0);
                updateTotal();
            }
        };
        anim();
    }

    window.rollAll = () => diceList.forEach(d => rollSingle(d));

    function updateTotal() {
        const total = diceList.reduce((acc, d) => acc + (d.userData.isRemoving ? 0 : d.userData.value), 0);
        document.getElementById('res-total').innerText = total;
    }

    function animate() {
        requestAnimationFrame(animate);
        diceList.forEach((dice, i) => {
            if(!dice.userData.isRemoving) {
                const tx = (i % 4 - 1.5) * 2.5;
                const ty = (1 - Math.floor(i / 4)) * 2.5;
                dice.position.x += (tx - dice.position.x) * 0.1;
                dice.position.y += (ty - dice.position.y) * 0.1;
            }
            const vector = dice.position.clone().project(camera);
            dice.userData.label.style.left = `${(vector.x + 1) * container.clientWidth / 2}px`;
            dice.userData.label.style.top = `${(-vector.y + 1) * container.clientHeight / 2}px`;
        });
        renderer.render(scene, camera);
    }
    init3D();

    // --- PERSONAGENS ---
    const deathSound = new Audio('sino-2deg.mp3');

    window.addNewCharacter = () => {
        const id = Date.now();
        const html = `
            <div class="character-card" id="char-${id}">
                <div class="char-header">
                    <div class="char-left-col">
                        <div class="char-image-container" onclick="document.getElementById('img-${id}').click()">
                            <img src="https://via.placeholder.com/140" id="view-${id}">
                            <input type="file" id="img-${id}" hidden onchange="updateImg(this, '${id}')">
                        </div>
                        <input type="text" class="rpg-input" style="width:140px; text-align:center" placeholder="Jogador">
                    </div>
                    <div class="header-inputs">
                        <div class="full-row"><span class="rpg-label">NOME DO PERSONAGEM</span><input type="text" class="rpg-input"></div>
                        <div><span class="rpg-label">CLASSE</span><input type="text" class="rpg-input"></div>
                        <div><span class="rpg-label">RAÇA</span><input type="text" class="rpg-input"></div>
                        <div><span class="rpg-label">NÍVEL</span><input type="number" class="rpg-input" value="1"></div>
                    </div>
                </div>
                <div class="hp-section">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px">
                        <span>PV</span><span id="hp-text-${id}">100 / 100</span>
                    </div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="hp-fill-${id}" style="width: 100%"></div></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="number" id="hp-max-${id}" class="rpg-input" value="100" onchange="updateHPDisplay('${id}')" placeholder="Max">
                        <input type="text" class="rpg-input" onkeypress="handleHP(event, '${id}')" placeholder="Dano (Enter)">
                    </div>
                </div>
                <div class="attribute-grid">
                    <div class="attr-box"><div>FOR</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>DES</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>CON</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>INT</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>SAB</div><input type="number" value="10"></div>
                    <div class="attr-box"><div>CAR</div><input type="number" value="10"></div>
                </div>
            </div>`;
        document.getElementById('charactersList').insertAdjacentHTML('afterbegin', html);
        window[`hp_${id}`] = 100;
        window[`dead_${id}`] = false;
    };

    window.handleHP = (e, id) => {
        if(e.key === 'Enter') {
            const val = eval(e.target.value);
            window[`hp_${id}`] = Math.max(0, window[`hp_${id}`] + val);
            updateHPDisplay(id);
            e.target.value = "";
        }
    };

    window.updateHPDisplay = (id) => {
        const max = parseInt(document.getElementById(`hp-max-${id}`).value) || 1;
        const current = window[`hp_${id}`];
        const perc = (current / max) * 100;
        document.getElementById(`hp-fill-${id}`).style.width = perc + "%";
        document.getElementById(`hp-text-${id}`).innerText = `${current} / ${max}`;

        if(current <= 0 && !window[`dead_${id}`]) {
            window[`dead_${id}`] = true;
            document.getElementById(`char-${id}`).classList.add('is-dead');
            deathSound.play();
            setTimeout(() => {
                document.getElementById(`char-${id}`).style.opacity = "0";
                setTimeout(() => document.getElementById(`char-${id}`).remove(), 1000);
            }, 3000);
        }
    };

    window.updateImg = (input, id) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById(`view-${id}`).src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    };
</script>
</body>
</html>