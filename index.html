<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>RPG NEXUS - THE ULTIMATE GUI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bg: #030305; --card: #0d0d16; --accent: #00f2ff; 
            --danger: #ff2e63; --success: #08f7af; --warn: #f39c12; --border: #1a1a2e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #e0e0e0; height: 100vh; display: flex; overflow: hidden; }

        #hero-section { flex: 1; padding: 20px; overflow-y: auto; transition: 0.4s; }
        
        /* PAINEL DE DADOS */
        #dice-panel { 
            width: 320px; background: var(--card); border-left: 2px solid var(--accent); 
            padding: 20px; display: flex; flex-direction: column; transition: 0.4s;
            position: relative;
        }
        #dice-panel.minimized { width: 45px; padding: 10px 5px; }
        #dice-panel.minimized > *:not(.toggle-btn) { display: none; }
        .toggle-btn { position: absolute; left: -15px; top: 20px; width: 30px; height: 30px; background: var(--accent); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; border: none; font-weight: bold; }

        .v3d-box { width: 100%; height: 220px; background: #000; border-radius: 15px; border: 1px solid #222; position: relative; }
        .d-label { position: absolute; font-weight: 900; color: #fff; pointer-events: none; font-size: 22px; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 6px; border: 1px solid var(--accent); z-index: 5; }

        #dice-log { flex: 1; overflow-y: auto; background: #05050a; border-radius: 8px; padding: 10px; border: 1px solid #1a1a1a; font-size: 13px; margin-top: 10px; }
        .log-entry { border-bottom: 1px solid #111; padding: 5px 0; display: flex; justify-content: space-between; }

        /* CARDS & MORTE */
        .char-card { background: var(--card); border: 1px solid var(--border); border-radius: 15px; margin-bottom: 25px; transition: 0.5s; position: relative; }
        .char-card.dead { filter: grayscale(1); border-color: var(--danger); box-shadow: 0 0 20px rgba(255, 46, 99, 0.2); }
        .char-card.dead::before { content: "☠️"; position: absolute; top: 10px; right: 10px; font-size: 20px; z-index: 5; }
        
        .card-header { padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .img-thumb { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; border: 2px solid var(--accent); transition: 0.3s; }
        
        .bar-bg { height: 14px; background: #000; border-radius: 7px; margin-top: 5px; border: 1px solid #333; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28); }

        .card-content { max-height: 0; overflow: hidden; transition: 0.5s ease; padding: 0 20px; }
        .char-card.expanded { border-color: var(--accent); }
        .char-card.expanded .card-content { max-height: 3000px; padding-bottom: 20px; }

        /* ABAS */
        .tab-bar { display: flex; gap: 10px; margin: 15px 0; border-bottom: 1px solid #222; overflow-x: auto; }
        .tab-btn { background: none; border: none; color: #666; cursor: pointer; padding: 10px; font-weight: bold; font-size: 11px; white-space: nowrap; }
        .tab-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        input, textarea, select { background: #05050a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px; outline: none; width: 100%; }
        input:focus { border-color: var(--accent); }

        /* ATRIBUTOS */
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .attr-item { background: #000; padding: 10px; border-radius: 12px; border: 1px solid #222; text-align: center; position: relative; }
        .attr-mod { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 5px; font-size: 12px; font-weight: 900; }
        
        /* INVENTARIO E SKILLS */
        .list-item { background: #05050a; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #222; border-left: 3px solid var(--accent); }

        .dice-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 15px; }
        .d-btn { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #000; font-size: 11px; }
    </style>
</head>
<body>

    <audio id="death-sound" src="sino-2deg.mp3" preload="auto"></audio>

    <div id="hero-section">
        <div style="display:flex; gap:15px; margin-bottom:20px">
            <button onclick="addNewHero()" style="background:var(--accent); color:#000; padding:12px 25px; border:none; border-radius:8px; font-weight:900; cursor:pointer">+ NOVO PERSONAGEM</button>
            <button onclick="saveAll()" style="background:none; border:1px solid var(--success); color:var(--success); padding:10px 20px; border-radius:8px; cursor:pointer">SALVAR SESSÃO</button>
        </div>
        <div id="hero-list"></div>
    </div>

    <aside id="dice-panel">
        <button class="toggle-btn" onclick="toggleDice()"> < </button>
        <div id="v3d-cont" class="v3d-box">
            <div id="total-val" style="position:absolute; top:10px; left:10px; font-size:35px; font-weight:900; color:var(--accent)">0</div>
        </div>
        <div class="dice-btns">
            <button class="d-btn" style="background:#4ecca3" onclick="addDice('d4', 4, '#4ecca3')">D4</button>
            <button class="d-btn" style="background:#45b7d1" onclick="addDice('d6', 6, '#45b7d1')">D6</button>
            <button class="d-btn" style="background:#a29bfe" onclick="addDice('d8', 8, '#a29bfe')">D8</button>
            <button class="d-btn" style="background:#ff7675" onclick="addDice('d10', 10, '#ff7675')">D10</button>
            <button class="d-btn" style="background:#fdcb6e" onclick="addDice('d12', 12, '#fdcb6e')">D12</button>
            <button class="d-btn" style="background:#00f2ff" onclick="addDice('d20', 20, '#00f2ff')">D20</button>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:11px; margin-top:15px; color:#555">
            <span>HISTÓRICO</span>
            <span onclick="document.getElementById('dice-log').innerHTML=''" style="color:var(--danger); cursor:pointer">LIMPAR</span>
        </div>
        <div id="dice-log"></div>
    </aside>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';

    // --- ENGINE DADOS 3D (RESTAURADA) ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 280/220, 0.1, 100); camera.position.z = 13;
    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(280, 220); document.getElementById('v3d-cont').appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 1.5));
    let diceList = [];
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const geos = { d4: new THREE.TetrahedronGeometry(1.3), d6: new THREE.BoxGeometry(1.5,1.5,1.5), d8: new THREE.OctahedronGeometry(1.5), d10: new THREE.IcosahedronGeometry(1.5,0), d12: new THREE.DodecahedronGeometry(1.5), d20: new THREE.IcosahedronGeometry(1.5,0) };

    window.toggleDice = () => {
        const p = document.getElementById('dice-panel');
        p.classList.toggle('minimized');
        p.querySelector('.toggle-btn').innerText = p.classList.contains('minimized') ? '>' : '<';
    };

    window.addDice = (type, sides, color) => {
        const mesh = new THREE.Mesh(geos[type], new THREE.MeshPhongMaterial({color, flatShading:true}));
        const lab = document.createElement('div'); lab.className = 'd-label';
        document.getElementById('v3d-cont').appendChild(lab);
        mesh.userData = { sides, lab, val: 0 };
        scene.add(mesh); diceList.push(mesh);
        
        const res = Math.floor(Math.random() * sides) + 1;
        let s = Date.now();
        const anim = () => {
            if(Date.now() - s < 600) { mesh.rotation.x += 0.3; mesh.rotation.y += 0.3; requestAnimationFrame(anim); }
            else { 
                mesh.rotation.set(0,0,0); mesh.userData.val = res; mesh.userData.lab.innerText = res; 
                mesh.userData.lab.style.display = 'block'; updateTotal(); addLog(type, res);
            }
        }; anim();
    };

    function addLog(t, v) {
        const div = document.createElement('div'); div.className = 'log-entry';
        div.innerHTML = `<span>${t.toUpperCase()}</span><b>${v}</b>`;
        document.getElementById('dice-log').prepend(div);
    }

    document.getElementById('v3d-cont').addEventListener('mousedown', (e) => {
        const r = document.getElementById('v3d-cont').getBoundingClientRect();
        mouse.x = ((e.clientX - r.left) / 280) * 2 - 1; mouse.y = -((e.clientY - r.top) / 220) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObjects(diceList);
        if(hits.length > 0) { hits[0].object.userData.lab.remove(); scene.remove(hits[0].object); diceList = diceList.filter(d => d !== hits[0].object); updateTotal(); }
    });

    function updateTotal() { document.getElementById('total-val').innerText = diceList.reduce((a,b)=>a+b.userData.val, 0); }

    function loop() {
        requestAnimationFrame(loop);
        diceList.forEach((d, i) => {
            const tx = (i % 3 - 1) * 3.5; const ty = (1 - Math.floor(i / 3)) * 3.5;
            d.position.x += (tx - d.position.x) * 0.1; d.position.y += (ty - d.position.y) * 0.1;
            const v = d.position.clone().project(camera);
            d.userData.lab.style.left = `${(v.x + 1) * 280 / 2}px`; d.userData.lab.style.top = `${(-v.y + 1) * 220 / 2}px`;
        });
        renderer.render(scene, camera);
    } loop();

    // --- SISTEMA DE PERSONAGEM ---
    window.addNewHero = (data = null) => {
        const id = data ? data.id : "h_" + Date.now();
        const div = document.createElement('div');
        div.className = "char-card" + (data ? "" : " expanded");
        div.id = id;
        
        div.innerHTML = `
            <div class="card-header" onclick="if(!event.target.closest('input')) this.parentElement.classList.toggle('expanded')">
                <img src="${data?.img || 'https://via.placeholder.com/60'}" class="img-thumb" id="thumb-${id}">
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px">
                        <b><span id="tag-${id}">${data?.name || 'Novo Herói'}</span> <small style="color:var(--accent); margin-left:10px" id="race-tag-${id}">${data?.race || ''}</small></b>
                        <span id="txt-${id}">100 / 100</span>
                    </div>
                    <div class="bar-bg"><div class="bar-fill" id="bar-${id}"></div></div>
                </div>
            </div>

            <div class="card-content">
                <div class="tab-bar">
                    <button class="tab-btn active" onclick="tab(event, '${id}', 't1')">GERAL</button>
                    <button class="tab-btn" onclick="tab(event, '${id}', 't2')">ATRIBUTOS & CLÃ</button>
                    <button class="tab-btn" onclick="tab(event, '${id}', 't3')">HABILIDADES</button>
                    <button class="tab-btn" onclick="tab(event, '${id}', 't4')">INVENTÁRIO</button>
                </div>

                <div id="t1-${id}" class="tab-pane active">
                    <div style="display:flex; gap:15px">
                        <img src="${data?.img || 'https://via.placeholder.com/100'}" id="img-${id}" onclick="document.getElementById('f-${id}').click()" style="width:100px; height:100px; border-radius:12px; cursor:pointer; object-fit:cover; border:1px solid #333">
                        <input type="file" id="f-${id}" hidden onchange="uImg(this, '${id}')">
                        <div style="flex:1">
                            <input type="text" class="i-name" placeholder="Nome" value="${data?.name || ''}" oninput="document.getElementById('tag-${id}').innerText=this.value">
                            <div style="display:flex; gap:10px; margin-top:10px">
                                <div><label style="font-size:10px">Dano/Cura</label><input type="text" onkeypress="combat(event, '${id}')" placeholder="Ex: -10"></div>
                                <div><label style="font-size:10px">Vida Máx</label><input type="number" id="max-${id}" value="${data?.max || 100}" oninput="changeMax('${id}')"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="t2-${id}" class="tab-pane">
                    <div style="background:#111; padding:12px; border-radius:10px; margin-bottom:15px; border:1px solid #222">
                        <label style="font-size:10px; color:var(--accent)">NOME DA RAÇA / CLÃ</label>
                        <input type="text" class="i-race" value="${data?.race || ''}" placeholder="Ex: Saiyajin, Elfo..." oninput="document.getElementById('race-tag-${id}').innerText=this.value">
                    </div>
                    <div class="attr-grid">
                        ${['FOR','DES','CON','INT','SAB','CAR'].map((a, i) => `
                            <div class="attr-item">
                                <span class="attr-mod" id="mod-${a}-${id}">+0</span>
                                <label style="font-size:10px; color:var(--accent)">${a}</label>
                                <input type="number" class="i-attr" value="${data?.attrs ? data.attrs[i] : 10}" oninput="calcAttr('${id}')" style="text-align:center; font-size:18px; font-weight:bold; background:none; border:none; margin-bottom:4px">
                                <input type="number" class="i-rb" value="${data?.rb ? data.rb[i] : 0}" oninput="calcAttr('${id}')" style="height:22px; font-size:10px; text-align:center" placeholder="+ Raça">
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div id="t3-${id}" class="tab-pane">
                    <div id="skill-list-${id}"></div>
                    <button onclick="addSkill('${id}')" style="width:100%; padding:10px; background:#111; color:var(--accent); border:1px dashed #444; border-radius:8px; cursor:pointer">+ NOVO PODER</button>
                </div>

                <div id="t4-${id}" class="tab-pane">
                    <div id="inv-list-${id}"></div>
                    <button onclick="addItem('${id}')" style="width:100%; padding:10px; background:#111; color:var(--success); border:1px dashed #444; border-radius:8px; cursor:pointer">+ ADICIONAR ITEM</button>
                </div>

                <button onclick="delHero('${id}')" style="margin-top:20px; color:var(--danger); background:none; border:none; cursor:pointer; font-size:10px; opacity:0.5">EXCLUIR PERSONAGEM</button>
            </div>`;
        
        document.getElementById('hero-list').prepend(div);
        window[`hp_cur_${id}`] = data ? parseInt(data.cur) : 100;
        if(data?.skills) data.skills.forEach(s => addSkill(id, s.n, s.c, s.t, s.d));
        if(data?.inventory) data.inventory.forEach(i => addItem(id, i.n, i.q, i.d));
        calcAttr(id);
        updateHP(id, false);
    };

    window.addSkill = (id, n="", c="", t="Ativa", d="") => {
        const div = document.createElement('div'); div.className = 'list-item';
        div.innerHTML = `
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input placeholder="Poder" value="${n}" class="s-n" style="flex:2">
                <input placeholder="Custo" value="${c}" class="s-c" style="flex:1">
                <select class="s-t" style="flex:1"><option ${t=='Ativa'?'selected':''}>Ativa</option><option ${t=='Passiva'?'selected':''}>Passiva</option></select>
                <button onclick="this.parentElement.parentElement.remove()" style="color:var(--danger); background:none; border:none; cursor:pointer">&times;</button>
            </div>
            <textarea placeholder="Descrição..." class="s-d" style="min-height:40px; font-size:11px">${d}</textarea>
        `;
        document.getElementById(`skill-list-${id}`).appendChild(div);
    };

    window.addItem = (id, n="", q="1", d="") => {
        const div = document.createElement('div'); div.className = 'list-item';
        div.style.borderColor = "var(--success)";
        div.innerHTML = `
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input placeholder="Item" value="${n}" class="i-n" style="flex:3">
                <input placeholder="Qtd" value="${q}" class="i-q" style="flex:1; text-align:center">
                <button onclick="this.parentElement.parentElement.remove()" style="color:var(--danger); background:none; border:none; cursor:pointer">&times;</button>
            </div>
            <textarea placeholder="Notas..." class="i-d" style="min-height:30px; font-size:11px">${d}</textarea>
        `;
        document.getElementById(`inv-list-${id}`).appendChild(div);
    };

    window.updateHP = (id, playSound = true) => {
        const card = document.getElementById(id);
        const max = parseInt(document.getElementById(`max-${id}`).value) || 1;
        let cur = window[`hp_cur_${id}`];
        if(cur > max) cur = max;
        
        const pct = (cur / max) * 100;
        document.getElementById(`bar-${id}`).style.width = Math.max(0, pct) + "%";
        document.getElementById(`txt-${id}`).innerText = `${cur} / ${max}`;

        if(cur <= 0) {
            if(!card.classList.contains('dead')) {
                card.classList.add('dead');
                if(playSound) document.getElementById('death-sound').play().catch(()=>{});
            }
        } else {
            card.classList.remove('dead');
        }
    };

    window.calcAttr = (id) => {
        const card = document.getElementById(id);
        const bases = card.querySelectorAll('.i-attr');
        const bonus = card.querySelectorAll('.i-rb');
        const labels = ['FOR','DES','CON','INT','SAB','CAR'];
        bases.forEach((el, i) => {
            const total = (parseInt(el.value) || 0) + (parseInt(bonus[i].value) || 0);
            const mod = Math.floor((total - 10) / 2);
            document.getElementById(`mod-${labels[i]}-${id}`).innerText = (mod >= 0 ? "+" : "") + mod;
        });
    };

    window.combat = (e, id) => {
        if(e.key === 'Enter') {
            let v = e.target.value; let c = window[`hp_cur_${id}`];
            if(v.startsWith('+') || v.startsWith('-')) c += eval(v); else c = parseInt(v);
            window[`hp_cur_${id}`] = c; updateHP(id, true); e.target.value = "";
        }
    };

    window.tab = (e, id, t) => {
        const p = document.getElementById(id);
        p.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        p.querySelectorAll('.tab-pane').forEach(x => x.classList.remove('active'));
        e.target.classList.add('active');
        p.querySelector(`#${t}-${id}`).classList.add('active');
    };

    window.uImg = (el, id) => {
        if(el.files[0]) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('img-'+id).src=e.target.result; document.getElementById('thumb-'+id).src=e.target.result; };
            r.readAsDataURL(el.files[0]);
        }
    };

    window.changeMax = (id) => { window[`hp_cur_${id}`] = parseInt(document.getElementById(`max-${id}`).value); updateHP(id, false); };
    window.delHero = (id) => { if(confirm("Apagar permanentemente?")) document.getElementById(id).remove(); };

    window.saveAll = () => {
        const data = [];
        document.querySelectorAll('.char-card').forEach(c => {
            const skills = []; c.querySelectorAll('#skill-list-'+c.id+' .list-item').forEach(s => skills.push({n:s.querySelector('.s-n').value, c:s.querySelector('.s-c').value, t:s.querySelector('.s-t').value, d:s.querySelector('.s-d').value}));
            const inventory = []; c.querySelectorAll('#inv-list-'+c.id+' .list-item').forEach(i => inventory.push({n:i.querySelector('.i-n').value, q:i.querySelector('.i-q').value, d:i.querySelector('.i-d').value}));
            const attrs = []; c.querySelectorAll('.i-attr').forEach(i => attrs.push(i.value));
            const rb = []; c.querySelectorAll('.i-rb').forEach(i => rb.push(i.value));
            data.push({ id: c.id, name: c.querySelector('.i-name').value, race: c.querySelector('.i-race').value, max: c.querySelector('.i-max').value, cur: window[`hp_cur_${c.id}`], img: c.querySelector('.img-thumb').src, attrs, rb, skills, inventory });
        });
        localStorage.setItem('nexus_final_v8', JSON.stringify(data));
        alert("Sessão Salva!");
    };

    const saved = localStorage.getItem('nexus_final_v8');
    if(saved) JSON.parse(saved).reverse().forEach(d => addNewHero(d));
</script>
</body>
</html>